name: Deploy to AWS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm ci
        
    - name: Build application
      run: |
        npm run build
        
    - name: Deploy to AWS
      uses: appleboy/ssh-action@master
      with:
        host: ec2-34-199-78-49.compute-1.amazonaws.com
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /home/ubuntu/brmh-backend
          git pull origin main
          npm ci --only=production
          # Install PM2 globally with sudo if not already installed
          which pm2 || sudo npm install -g pm2
          # Stop any existing instances
          pm2 stop brmh-backend || true
          pm2 delete brmh-backend || true
          # Start the application as a system service
          pm2 start npm --name "brmh-backend" -- start
          # Save PM2 process list
          pm2 save
          # Setup PM2 startup script if not already setup
          pm2 startup systemd -u ubuntu --hp /home/ubuntu || true
          # Save PM2 process list again to ensure it persists across reboots
          pm2 save
          # Verify the service is running
          pm2 list 